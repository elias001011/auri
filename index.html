<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auri - Chatbot Privado</title>
    <style>
        /* Reset básico e estilos globais */
        :root {
            /* Tema Claro */
            --bg-color-light: #ffffff;
            --text-color-light: #000000;
            --sidebar-bg-light: #f9fafb;
            --input-bg-light: #f3f4f6;
            --border-color-light: #e5e7eb;
            --hover-bg-light: #e5e7eb;
            --user-msg-bg-light: #e0f2fe;
            --ai-msg-bg-light: #f3f4f6;
            --overlay-bg-light: rgba(255, 255, 255, 0.7);
            --placeholder-color-light: #6b7280;

            /* Tema Escuro (Padrão - Preto Absoluto) */
            --bg-color-dark: #000000;
            --text-color-dark: #ffffff;
            --sidebar-bg-dark: #0a0a0a;
            --input-bg-dark: #111111;
            --border-color-dark: #2a2a2a;
            --hover-bg-dark: #1f1f1f;
            --user-msg-bg-dark: #212c40;
            --ai-msg-bg-dark: #181818;
            --overlay-bg-dark: rgba(0, 0, 0, 0.7);
            --placeholder-color-dark: #9ca3af;

            /* Cores de destaque */
            --accent-color: #3b82f6;
            --accent-text-color: #ffffff;

            /* Fontes e Dimensões */
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --border-radius: 8px;
            --padding-sm: 8px;
            --padding-md: 16px;
            --padding-lg: 24px;
            /* Inicialmente define as variáveis do tema ESCURO como padrão */
            --bg-color: var(--bg-color-dark);
            --text-color: var(--text-color-dark);
            --sidebar-bg: var(--sidebar-bg-dark);
            --input-bg: var(--input-bg-dark);
            --border-color: var(--border-color-dark);
            --hover-bg: var(--hover-bg-dark);
            --user-msg-bg: var(--user-msg-bg-dark);
            --ai-msg-bg: var(--ai-msg-bg-dark);
            --overlay-bg: var(--overlay-bg-dark);
            --bg-color-rgb: 0, 0, 0; /* RGB para overlay */
            --placeholder-color: var(--placeholder-color-dark);
            color-scheme: dark;
        }

        [data-theme="light"] {
            --bg-color: var(--bg-color-light);
            --text-color: var(--text-color-light);
            --sidebar-bg: var(--sidebar-bg-light);
            --input-bg: var(--input-bg-light);
            --border-color: var(--border-color-light);
            --hover-bg: var(--hover-bg-light);
            --user-msg-bg: var(--user-msg-bg-light);
            --ai-msg-bg: var(--ai-msg-bg-light);
            --overlay-bg: var(--overlay-bg-light);
            --bg-color-rgb: 255, 255, 255; /* RGB para overlay */
            --placeholder-color: var(--placeholder-color-light);
            color-scheme: light;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; display: flex; transition: background-color 0.3s, color 0.3s; }
        button, input, textarea, select { font-family: inherit; font-size: inherit; color: inherit; border-radius: var(--border-radius); }
        button { cursor: pointer; border: none; background-color: transparent; padding: var(--padding-sm) var(--padding-md); transition: background-color 0.2s, opacity 0.2s; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        input::placeholder, textarea::placeholder { color: var(--placeholder-color); opacity: 1; }
        :root { scrollbar-color: var(--input-bg) var(--bg-color); scrollbar-width: thin; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background-color: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background-color: var(--input-bg); border-radius: 4px; border: 2px solid var(--bg-color); }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--hover-bg); }

        /* Layout Principal */
        .app-container { display: flex; width: 100%; height: 100%; }
        /* --- Barra Lateral --- */
        .sidebar { width: 260px; background-color: var(--sidebar-bg); padding: var(--padding-md); display: flex; flex-direction: column; border-right: 1px solid var(--border-color); transition: width 0.3s ease, padding 0.3s ease, transform 0.3s ease, background-color 0.3s; flex-shrink: 0; position: relative; }
        .sidebar.collapsed { width: 0; padding: var(--padding-md) 0; overflow: hidden; border-right: none; transform: translateX(-100%); }
        .sidebar-header { display: flex; align-items: center; margin-bottom: var(--padding-lg); padding-left: 45px; position: relative; min-height: 30px; }
        .sidebar-toggle-button { position: absolute; top: 15px; left: 10px; z-index: 1100; background-color: var(--input-bg); border: 1px solid var(--border-color); padding: 5px; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; font-size: 1.2em; line-height: 1; transition: transform 0.3s ease, left 0.3s ease, background-color 0.2s; }
        .sidebar-toggle-button:hover { background-color: var(--hover-bg); }
        .sidebar-toggle-button.outside { position: fixed; left: 10px; transform: translateX(0); }
        .sidebar-title { font-size: 1.4em; font-weight: bold; }
        .new-chat-button { background-color: var(--accent-color); color: var(--accent-text-color); text-align: center; margin-bottom: var(--padding-lg); width: 100%; }
        .new-chat-button:hover { opacity: 0.9; }
        .chat-list-container { flex-grow: 1; overflow-y: auto; margin-bottom: var(--padding-md); }
        .chat-list { list-style: none; }
        .chat-list-item { padding: var(--padding-sm) var(--padding-md); border-radius: var(--border-radius); margin-bottom: var(--padding-sm); cursor: pointer; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .chat-list-item:hover { background-color: var(--hover-bg); }
        .chat-list-item.active { background-color: var(--input-bg); }
        .chat-item-actions { display: none; position: absolute; right: var(--padding-sm); top: 50%; transform: translateY(-50%); background-color: var(--sidebar-bg); padding-left: 5px; }
        .chat-list-item:hover .chat-item-actions { display: flex; gap: 5px; }
        .chat-item-actions button { padding: 3px; font-size: 0.9em; background: none; color: var(--text-color); }
        .settings-button { margin-top: auto; display: flex; align-items: center; justify-content: center; gap: var(--padding-sm); width: 100%; border: 1px solid var(--border-color); }
        .settings-button:hover { background-color: var(--hover-bg); }
        /* --- Área de Chat --- */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .chat-header { padding: var(--padding-md); border-bottom: 1px solid var(--border-color); text-align: center; font-weight: bold; flex-shrink: 0; }
        .message-list-wrapper { flex-grow: 1; overflow-y: auto; padding: var(--padding-lg); display: flex; flex-direction: column; }
        .empty-chat-state { text-align: center; margin: auto; color: #9ca3af; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .empty-chat-state h2 { font-size: 2em; margin-bottom: var(--padding-md); color: var(--text-color); }
        .prompt-suggestions { display: flex; flex-direction: column; align-items: stretch; gap: 10px; margin-top: var(--padding-lg); width: 80%; max-width: 400px; }
        .prompt-suggestions button { background-color: var(--input-bg); border: 1px solid var(--border-color); padding: var(--padding-md); text-align: left; border-radius: var(--border-radius); width: 100%; transition: background-color 0.2s; color: var(--text-color); }
        .prompt-suggestions button:hover { background-color: var(--hover-bg); }
        .message-list { flex-grow: 1; display: flex; flex-direction: column; gap: var(--padding-md); }
        .message { display: flex; max-width: 80%; position: relative; }
        .message.user { align-self: flex-end; }
        .message.ai { align-self: flex-start; }
        .message-content { padding: var(--padding-sm) var(--padding-md); border-radius: var(--border-radius); word-wrap: break-word; white-space: pre-wrap; }
        /* Estilo para imagens removido, pois anexos foram removidos */
        .message-content ul, .message-content ol { margin-left: 25px; margin-top: 8px; margin-bottom: 8px; padding-left: 0; }
        .message-content li { margin-bottom: 4px; }
        .message-content pre { background-color: var(--input-bg); padding: var(--padding-md); border-radius: var(--border-radius); margin: var(--padding-sm) 0; overflow-x: auto; border: 1px solid var(--border-color); font-family: 'Courier New', Courier, monospace; font-size: 0.9em; color: var(--text-color); }
        .message-content code { font-family: 'Courier New', Courier, monospace; color: var(--text-color); }
        .message-content code:not(pre code) { background-color: var(--input-bg); padding: 2px 5px; border-radius: 4px; font-size: 0.9em; border: 1px solid var(--border-color); }
        .message-content a { color: var(--accent-color); text-decoration: underline; }
        .message-content a:hover { opacity: 0.8; }
        .message-content strong { font-weight: bold; }
        .message-content em { font-style: italic; }
        .message.user .message-content { background-color: var(--user-msg-bg); color: var(--text-color); }
        .message.ai .message-content { background-color: var(--ai-msg-bg); color: var(--text-color); }
        .message-actions { position: absolute; bottom: -5px; right: 5px; display: none; gap: 5px; background-color: rgba(var(--bg-color-rgb), 0.7); padding: 2px 5px; border-radius: 4px; z-index: 1; }
        .message:hover .message-actions { display: flex; }
        .message-actions button { padding: 2px 4px; font-size: 0.8em; background: none; border: 1px solid var(--border-color); color: var(--text-color); }
        .message-actions button:hover { background-color: var(--hover-bg); }
        .typing-indicator { text-align: center; padding: var(--padding-sm); color: #9ca3af; font-style: italic; display: none; }
        .typing-indicator.visible { display: block; }
        .chat-footer { text-align: center; font-size: 0.8em; color: #9ca3af; padding: var(--padding-sm) 0; flex-shrink: 0; }
        /* --- Área de Input --- */
        .input-area { display: flex; flex-direction: column; padding: var(--padding-md); border-top: 1px solid var(--border-color); background-color: var(--bg-color); gap: var(--padding-sm); flex-shrink: 0; }
        .input-row { display: flex; align-items: flex-end; width: 100%; gap: var(--padding-sm); }
        /* Preview de anexo removido */
        .message-input { flex-grow: 1; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: var(--padding-sm) var(--padding-md); resize: none; min-height: 40px; max-height: 200px; overflow-y: auto; line-height: 1.4; color: var(--text-color); }
        .input-button { background-color: var(--input-bg); border: 1px solid var(--border-color); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: var(--text-color); }
        .input-button:hover { background-color: var(--hover-bg); }
        .input-button.send-button { background-color: var(--accent-color); border-color: var(--accent-color); color: var(--accent-text-color); }
        .input-button.send-button:hover { opacity: 0.9; background-color: var(--accent-color); }
        /* Classe .hidden removida pois os botões foram removidos */
        /* --- Modals / Pop-ups --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-color); padding: var(--padding-lg); border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); max-width: 90%; width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--padding-md); border-bottom: 1px solid var(--border-color); padding-bottom: var(--padding-sm); }
        .modal-title { font-size: 1.3em; font-weight: bold; }
        .modal-close-button { font-size: 1.8em; line-height: 1; padding: 0 5px; margin: -5px; background: none; border: none; font-weight: bold; color: var(--text-color); }
        .modal-close-button:hover { opacity: 0.7; }
        .modal-body { margin-bottom: var(--padding-lg); }
        #policy-modal-body strong { font-weight: bold; }
        #policy-modal-body { white-space: pre-wrap; }
        #generic-modal-body strong { font-weight: bold; }
        .modal-footer { display: flex; justify-content: flex-end; gap: var(--padding-sm); border-top: 1px solid var(--border-color); padding-top: var(--padding-md); }
        .modal-button { padding: var(--padding-sm) var(--padding-lg); border: 1px solid var(--border-color); }
        .modal-button:hover { background-color: var(--hover-bg); }
        .modal-button.primary { background-color: var(--accent-color); color: var(--accent-text-color); border-color: var(--accent-color); }
        .modal-button.primary:hover { opacity: 0.9; background-color: var(--accent-color); }
        .modal-button.danger { background-color: #ef4444; color: #ffffff; border-color: #ef4444; }
        .modal-button.danger:hover { opacity: 0.9; background-color: #ef4444; }
        /* Estilos Configurações */
        .settings-section { margin-bottom: var(--padding-lg); }
        .settings-section h4 { margin-bottom: var(--padding-sm); font-weight: bold; }
        .settings-section label { display: block; margin-bottom: 5px; font-size: 0.9em; }
        .settings-section input[type="text"], .settings-section select, .settings-section textarea { width: 100%; padding: var(--padding-sm); border: 1px solid var(--border-color); background-color: var(--input-bg); border-radius: var(--border-radius); margin-bottom: var(--padding-sm); color: var(--text-color); }
        .settings-section select { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); }
        .settings-section select option { background-color: var(--bg-color); color: var(--text-color); }
        .settings-section textarea { min-height: 80px; resize: vertical; }
        .settings-section small { font-size: 0.8em; color: #9ca3af; margin-right: 5px; }
        .suggestion-btn { font-size: 0.8em; padding: 2px 6px; margin-right: 4px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; }
        .suggestion-btn:hover { background-color: var(--hover-bg); }
        .color-options { display: flex; gap: var(--padding-sm); }
        .color-option { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; }
        .color-option.selected { border-color: var(--text-color); }
        .theme-toggle-button, .clear-data-button { width: 100%; margin-top: var(--padding-sm); border: 1px solid var(--border-color); padding: var(--padding-sm) var(--padding-md); }
        .theme-toggle-button:hover, .clear-data-button:hover { background-color: var(--hover-bg); }
        .clear-data-button { border-color: #f87171; color: #ef4444; }
        [data-theme="dark"] .clear-data-button { border-color: #ef4444; color: #fca5a5; }
        [data-theme="dark"] .clear-data-button:hover { background-color: #7f1d1d; }
        #message-limit-display { font-size: 0.9em; color: var(--text-color); margin-top: var(--padding-sm); }
        .settings-links a { color: var(--accent-color); text-decoration: none; margin-right: var(--padding-md); font-size: 0.9em; }
        .settings-links a:hover { text-decoration: underline; }
        /* Overlay de Carregamento e Botão Parar */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--overlay-bg); display: none; justify-content: center; align-items: center; z-index: 1500; flex-direction: column; gap: var(--padding-md); }
        #loading-overlay.visible { display: flex; }
        #typing-indicator-overlay { font-style: italic; color: var(--text-color); }
        #stop-generation-btn { background-color: #ef4444; color: #ffffff; border: 1px solid #dc2626; padding: var(--padding-sm) var(--padding-lg); }
        #stop-generation-btn:hover { background-color: #dc2626; }
        /* Responsividade */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; height: 100%; z-index: 100; transform: translateX(-100%); transition: transform 0.3s ease; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2); }
            .sidebar:not(.collapsed) { transform: translateX(0); }
            .sidebar.collapsed { transform: translateX(-100%); width: 260px; padding: var(--padding-md); border-right: 1px solid var(--border-color); }
            .sidebar-toggle-button { position: fixed; left: 10px; top: 10px; transform: translateX(0); z-index: 1100; }
            .sidebar:not(.collapsed) .sidebar-header { padding-left: 45px; }
            .chat-area { width: 100%; }
            .message { max-width: 90%; }
            .modal-content { width: 90%; }
            .prompt-suggestions { width: 90%; }
        }
        /* Imagem em Tela Cheia (Overlay ainda existe, mas não será usado) */
        #fullscreen-image-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 2000; cursor: pointer; }
        #fullscreen-image-overlay.visible { display: flex; }
        #fullscreen-image-overlay img { max-width: 90%; max-height: 90%; object-fit: contain; }
    </style>
</head>

<body>

    <div class="app-container">
        <button class="sidebar-toggle-button outside" id="sidebar-toggle-btn"
            aria-label="Alternar Barra Lateral">☰</button>
        <aside class="sidebar collapsed" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Auri</div>
            </div>
            <button class="new-chat-button" id="new-chat-btn">+ Novo Chat</button>
            <div class="chat-list-container">
                <ul class="chat-list" id="chat-list"></ul>
            </div>
            <button class="settings-button" id="settings-btn">⚙️ Configurações</button>
        </aside>
        <main class="chat-area">
            <div class="chat-header" id="chat-header">Novo Chat</div>
            <div class="message-list-wrapper" id="message-list-wrapper">
                <div class="empty-chat-state" id="empty-chat-state">
                    <h2 id="greeting">Bom Dia!</h2>
                    <p>Como posso ajudar hoje?</p>
                    <div class="prompt-suggestions" id="prompt-suggestions"></div>
                </div>
                <div class="message-list" id="message-list"></div>
                <div class="typing-indicator" id="typing-indicator">Auri está digitando...</div>
            </div>
            <div class="input-area" id="input-area">
                <!-- Container de preview de anexo removido -->
                <div class="input-row">
                    <!-- Botão de Anexo Removido -->
                    <!-- Botão de Pesquisa Web Removido -->
                    <textarea class="message-input" id="message-input" placeholder="Digite sua mensagem aqui..."
                        rows="1"></textarea>
                    <button class="input-button send-button" id="send-btn" aria-label="Enviar Mensagem">⬆️</button>
                </div>
            </div>
            <div class="chat-footer">Auri pode cometer erros. Focado em privacidade.</div>
        </main>
    </div>

    <div id="loading-overlay">
        <div id="typing-indicator-overlay" style="color: var(--text-color);">Auri está digitando...</div>
        <button id="stop-generation-btn">Parar Geração</button>
    </div>

    <!-- Overlay de imagem mantido, mas não será mais ativado -->
    <div id="fullscreen-image-overlay">
        <img id="fullscreen-image" src="#" alt="Imagem em tela cheia">
    </div>

    <!-- Modals (Mantidos iguais) -->
    <div class="modal-overlay" id="agreement-modal">
        <div class="modal-content">
            <div class="modal-header"> <h3 class="modal-title">Bem-vindo ao Auri!</h3> </div>
            <div class="modal-body">
                <p><strong>Foco em Privacidade:</strong> O Auri foi projetado pensando na sua privacidade. Não exigimos cadastro e seu histórico de conversas e configurações são salvos <strong>apenas no seu dispositivo</strong>.</p>
                <p><strong>APIs de Terceiros:</strong> Para funcionar, o Auri utiliza a API do modelo Gemma 3 via OpenRouter (através de um proxy seguro). O uso desse modelo está sujeito aos termos de serviço e políticas de privacidade do OpenRouter. Não podemos garantir 100% de segurança ou privacidade nas interações com essa API externa.</p>
                <p><strong>Gratuito e Experimental:</strong> Este é um projeto gratuito, desenvolvido por uma única pessoa, com orçamento limitado. Isso significa que podem ocorrer instabilidades.</p>
                <p><strong>Termos e Política:</strong> Antes de usar, recomendamos ler nossos <a href="#" id="agreement-terms-link">Termos de Uso</a> e <a href="#" id="agreement-privacy-link">Política de Privacidade</a> para entender como o Auri funciona.</p>
                <p><strong>Ao clicar em "Concordo", você aceita estes termos.</strong></p>
            </div>
            <div class="modal-footer"><button class="modal-button primary" id="agree-btn">Concordo</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="settings-modal">
         <div class="modal-content">
             <div class="modal-header">
                 <h3 class="modal-title">Configurações</h3>
                 <button class="modal-close-button" data-modal-close="settings-modal">&times;</button>
             </div>
             <div class="modal-body">
                 <div class="settings-section">
                     <h4>Resposta da IA</h4>
                     <label for="ai-lang">Idioma de Resposta da IA:</label>
                     <select id="ai-lang"> <option value="auto">Automático</option> <option value="pt">Português</option> <option value="en">English</option> <option value="es">Español</option> <option value="fr">Français</option> <option value="de">Deutsch</option> </select>
                     <label for="user-name">Como a IA pode te chamar (opcional):</label>
                     <input type="text" id="user-name" placeholder="Seu nome ou apelido">
                 </div>
                 <div class="settings-section">
                     <h4>Instruções Personalizadas (Prompt de Sistema)</h4>
                     <textarea id="custom-instructions" placeholder="Ex: Aja como um assistente prestativo e conciso."></textarea>
                     <div> <small>Sugestões:</small> <button class="suggestion-btn" data-suggestion="+empático">+empático</button> <button class="suggestion-btn" data-suggestion="+formal">+formal</button> <button class="suggestion-btn" data-suggestion="+criativo">+criativo</button> </div>
                 </div>
                 <div class="settings-section">
                     <h4>Aparência</h4>
                     <label>Cor de Destaque:</label>
                     <div class="color-options" id="color-options">
                         <div class="color-option" data-color="#3b82f6" style="background-color: #3b82f6;" title="Azul"></div>
                         <div class="color-option" data-color="#10b981" style="background-color: #10b981;" title="Verde"></div>
                         <div class="color-option" data-color="#ec4899" style="background-color: #ec4899;" title="Rosa"></div>
                         <div class="color-option" data-color="#8b5cf6" style="background-color: #8b5cf6;" title="Roxo"></div>
                         <div class="color-option" data-color="#f59e0b" style="background-color: #f59e0b;" title="Amarelo"></div>
                     </div>
                     <button class="theme-toggle-button" id="theme-toggle-btn">Alternar para Tema Claro</button>
                 </div>
                 <div class="settings-section">
                     <h4>Dados</h4>
                     <div id="message-limit-display">Mensagens restantes hoje: 10/10</div>
                     <button class="clear-data-button" id="clear-data-btn">Limpar Todos os Dados Locais</button>
                 </div>
                 <div class="settings-section settings-links">
                     <h4>Sobre</h4>
                     <a href="#" id="settings-terms-link">Termos de Uso</a>
                     <a href="#" id="settings-privacy-link">Política de Privacidade</a>
                 </div>
             </div>
             <div class="modal-footer"> <button class="modal-button" data-modal-close="settings-modal">Fechar</button> </div>
         </div>
     </div>
     <div class="modal-overlay" id="generic-modal">
         <div class="modal-content">
             <div class="modal-header"> <h3 class="modal-title" id="generic-modal-title">Aviso</h3> <button class="modal-close-button" data-modal-close="generic-modal">&times;</button> </div>
             <div class="modal-body" id="generic-modal-body"> <p>Conteúdo do modal aqui.</p> </div>
             <div class="modal-footer" id="generic-modal-footer"> <button class="modal-button" data-modal-close="generic-modal">Fechar</button> </div>
         </div>
     </div>
     <div class="modal-overlay" id="policy-modal">
         <div class="modal-content">
             <div class="modal-header"> <h3 class="modal-title" id="policy-modal-title">Documento</h3> <button class="modal-close-button" data-modal-close="policy-modal">&times;</button> </div>
             <div class="modal-body" id="policy-modal-body">Carregando...</div>
             <div class="modal-footer"> <button class="modal-button" data-modal-close="policy-modal">Fechar</button> </div>
         </div>
     </div>

    <!-- Input de arquivo removido -->

    <script>
        // --- Constantes e Variáveis Globais --- //
        // API_KEYS removido, pois não é mais usado no frontend
        const MODEL_ID = 'google/gemma-3-27b-it:free';
        // Config do modelo removido suporte a imagem/web search, pois botões foram removidos
        const MODEL_CONFIG = { name: 'Gemma 3 27B (Free)', provider: 'openrouter', supportsImage: false, supportsWebSearch: false };
        const MAX_DAILY_MESSAGES = 10; // Limite diário

        let state = {
            chats: {},
            currentChatId: null,
            settings: {
                theme: 'dark',
                accentColor: '#3b82f6',
                aiLang: 'auto',
                userName: '',
                customInstructions: '',
                agreedToTerms: false,
                dailyMessageCount: 0,
                lastMessageDate: null
            },
            isAiResponding: false
            // webSearchActive e attachedImage removidos
        };
        let currentRequestController = null;

        // --- Referências do DOM (simplificadas) --- //
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatList = document.getElementById('chat-list');
        const settingsBtn = document.getElementById('settings-btn');
        const chatHeader = document.getElementById('chat-header');
        const messageListWrapper = document.getElementById('message-list-wrapper');
        const messageList = document.getElementById('message-list');
        const emptyChatState = document.getElementById('empty-chat-state');
        const greeting = document.getElementById('greeting');
        const promptSuggestions = document.getElementById('prompt-suggestions');
        const typingIndicator = document.getElementById('typing-indicator');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        // Referências para attachBtn, webSearchBtn, fileInput, e elementos de preview removidas
        const agreementModal = document.getElementById('agreement-modal');
        const settingsModal = document.getElementById('settings-modal');
        const genericModal = document.getElementById('generic-modal');
        const policyModal = document.getElementById('policy-modal');
        const agreeBtn = document.getElementById('agree-btn');
        const agreementTermsLink = document.getElementById('agreement-terms-link');
        const agreementPrivacyLink = document.getElementById('agreement-privacy-link');
        const loadingOverlay = document.getElementById('loading-overlay');
        const stopGenerationBtn = document.getElementById('stop-generation-btn');
        const fullscreenImageOverlay = document.getElementById('fullscreen-image-overlay'); // Mantido, mas não será ativado
        const fullscreenImage = document.getElementById('fullscreen-image');
        const aiLangSelect = document.getElementById('ai-lang');
        const userNameInput = document.getElementById('user-name');
        const customInstructionsTextarea = document.getElementById('custom-instructions');
        const suggestionBtns = document.querySelectorAll('.suggestion-btn');
        const colorOptionsContainer = document.getElementById('color-options');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const settingsTermsLink = document.getElementById('settings-terms-link');
        const settingsPrivacyLink = document.getElementById('settings-privacy-link');
        const messageLimitDisplay = document.getElementById('message-limit-display');

        // --- Traduções (Removido referências a attach/web search labels) --- //
        const t = {
            toggleSidebar: "Alternar Barra Lateral", newChat: "+ Novo Chat", settings: "⚙️ Configurações",
            chatHeaderDefault: "Novo Chat", greetingMorning: "Bom Dia!", greetingAfternoon: "Boa Tarde!",
            greetingEvening: "Boa Noite!", greetingHelp: "Como posso ajudar hoje?",
            typingIndicator: "Auri está digitando...", inputPlaceholder: "Digite sua mensagem aqui...",
            inputPlaceholderWaiting: "Aguarde...", sendLabel: "Enviar Mensagem",
            // attachLabel e webSearchLabel removidos
            footerNote: "Auri pode cometer erros. Focado em privacidade.",
            welcomeTitle: "Bem-vindo ao Auri!", termsLink: "Termos de Uso", privacyLink: "Política de Privacidade",
            agreeButton: "Concordo", settingsTitle: "Configurações", settingsAiLang: "Idioma de Resposta da IA:",
            settingsAiLangAuto: "Automático", settingsUserName: "Como a IA pode te chamar (opcional):",
            settingsUserNamePlaceholder: "Seu nome ou apelido", settingsCustomInstructions: "Instruções Personalizadas (Prompt de Sistema)",
            settingsCustomInstructionsPlaceholder: "Ex: Aja como um assistente prestativo e conciso.",
            settingsSuggestions: "Sugestões:", settingsAppearance: "Aparência", settingsAccentColor: "Cor de Destaque:",
            settingsThemeToggleLight: "Alternar para Tema Escuro", settingsThemeToggleDark: "Alternar para Tema Claro",
            settingsData: "Dados", settingsClearData: "Limpar Todos os Dados Locais", settingsAbout: "Sobre",
            modalClose: "Fechar", modalConfirm: "Confirmar", modalCancel: "Cancelar", modalErrorTitle: "Erro",
            modalWarningTitle: "Aviso", modalInfoTitle: "Informação", modalSuccessTitle: "Sucesso",
            modalConfirmDeleteTitle: "Confirmar Exclusão", modalConfirmDeleteBody: "Tem certeza que deseja excluir o chat \"{chatName}\"? Esta ação não pode ser desfeita.",
            modalConfirmDeleteButton: "Confirmar Exclusão", modalConfirmClearDataTitle: "Confirmar Limpeza de Dados",
            modalConfirmClearDataBody: "<strong>Atenção!</strong> Tem certeza que deseja limpar TODOS os seus chats e configurações salvos localmente? Esta ação é irreversível.",
            modalConfirmClearDataButton: "Confirmar Limpeza", modalRenameTitle: "Renomear Chat",
            modalRenameLabel: "Novo nome para \"{chatName}\":", modalRenameSave: "Salvar", modalRenameErrorEmpty: "O nome do chat não pode ficar vazio.",
            modalLimitTitle: "Limite Atingido", modalLimitBody: "Você atingiu o limite de {limit} mensagens hoje. Por favor, volte amanhã.",
            modalLimitWarningTitle: "Aviso de Limite", modalLimitWarningBody: "Você tem {remaining} mensagens restantes hoje.",
            modalApiError: "Desculpe, ocorreu um erro ao processar sua solicitação: {error}. Tente novamente.",
            modalApiRegenError: "Erro ao regenerar: {error}. A resposta anterior foi mantida.", modalCopySuccess: "Copiado!",
            modalCopyError: "Não foi possível copiar o texto.",
            // Erros de arquivo removidos
            modalGenericError: "Ocorreu um erro inesperado.",
            chatItemRename: "Renomear Chat", chatItemDelete: "Excluir Chat", messageCopy: "Copiar",
            messageRegenerate: "Regerar",
            // removeAttachment removido
            colorBlue: "Azul", colorGreen: "Verde", colorPink: "Rosa", colorPurple: "Roxo", colorYellow: "Amarelo",
            stopGeneration: "Parar Geração", generationStopped: "Geração interrompida pelo usuário.",
            messageLimitStatus: "Mensagens restantes hoje: {remaining}/{total}"
        };

        // applyTranslations não precisa mais setar labels para botões removidos
        const applyTranslations = () => {
             const setText = (selector, key, prop = 'textContent') => { const el = document.querySelector(selector); if (el && t[key]) el[prop] = t[key]; };
             const setAttr = (selector, key, attr) => { const el = document.querySelector(selector); if (el && t[key]) el.setAttribute(attr, t[key]); };
             document.documentElement.lang = 'pt-BR';
             setAttr('#sidebar-toggle-btn', 'toggleSidebar', 'aria-label'); setText('#new-chat-btn', 'newChat'); setText('#settings-btn', 'settings');
             setText('#empty-chat-state p', 'greetingHelp'); setText('#typing-indicator', 'typingIndicator'); setAttr('#message-input', 'inputPlaceholder', 'placeholder');
             setAttr('#send-btn', 'sendLabel', 'aria-label');
             // Labels de anexo/web search removidos
             setText('.chat-footer', 'footerNote');
             // Label de remover anexo removido
             setText('#agreement-modal .modal-title', 'welcomeTitle'); setText('#agree-btn', 'agreeButton');
             setText('#agreement-terms-link', 'termsLink'); setText('#agreement-privacy-link', 'privacyLink');
             setText('#settings-modal .modal-title', 'settingsTitle'); setText('label[for="ai-lang"]', 'settingsAiLang');
             setText('#ai-lang option[value="auto"]', 'settingsAiLangAuto');
             // Outras opções de idioma
             setText('label[for="user-name"]', 'settingsUserName'); setAttr('#user-name', 'settingsUserNamePlaceholder', 'placeholder');
             document.querySelectorAll('#settings-modal .settings-section h4').forEach(h4 => {
                const content = h4.textContent.toLowerCase();
                if (content.includes('resposta')) h4.textContent = 'Resposta da IA';
                else if (content.includes('instruções')) h4.textContent = t.settingsCustomInstructions;
                else if (content.includes('aparência')) h4.textContent = t.settingsAppearance;
                else if (content.includes('dados')) h4.textContent = t.settingsData;
                else if (content.includes('sobre')) h4.textContent = t.settingsAbout;
            });
            const colorLabel = document.querySelector('#settings-modal .settings-section label:not([for])'); if (colorLabel) colorLabel.textContent = t.settingsAccentColor;
             setAttr('#custom-instructions', 'settingsCustomInstructionsPlaceholder', 'placeholder');
             setText('#theme-toggle-btn', state.settings.theme === 'dark' ? t.settingsThemeToggleDark : t.settingsThemeToggleLight);
             setText('#clear-data-btn', 'settingsClearData'); setText('#settings-terms-link', 'termsLink'); setText('#settings-privacy-link', 'privacyLink');
             const settingsCloseBtn = document.querySelector('#settings-modal .modal-footer button[data-modal-close]'); if (settingsCloseBtn) settingsCloseBtn.textContent = t.modalClose;
             setAttr('.color-option[data-color="#3b82f6"]', 'colorBlue', 'title'); setAttr('.color-option[data-color="#10b981"]', 'colorGreen', 'title');
             setAttr('.color-option[data-color="#ec4899"]', 'colorPink', 'title'); setAttr('.color-option[data-color="#8b5cf6"]', 'colorPurple', 'title');
             setAttr('.color-option[data-color="#f59e0b"]', 'colorYellow', 'title');
             setText('#greeting', t[getGreetingKey()]); setText('#stop-generation-btn', 'stopGeneration'); updateMessageLimitDisplay();
        };

        // --- Funções Utilitárias (Mantidas iguais, exceto onde anotado) --- //
        const saveState = () => { try { localStorage.setItem('auriState', JSON.stringify(state)); } catch (e) { console.error("Erro ao salvar estado:", e); showModal(t.modalErrorTitle, 'Falha ao salvar dados no armazenamento local.'); } };
        const loadState = () => { try { const saved = localStorage.getItem('auriState'); if (saved) { const parsed = JSON.parse(saved); const { selectedModel, interfaceLang, ...settings } = parsed.settings || {}; state = { ...state, ...parsed, settings: { ...state.settings, ...settings, theme: settings.theme || 'dark' }, chats: typeof parsed.chats === 'object' && parsed.chats !== null ? parsed.chats : {} }; if (typeof state.settings.agreedToTerms !== 'boolean') state.settings.agreedToTerms = false; checkDailyLimit(false); } } catch (e) { console.error("Erro ao carregar estado:", e); showModal(t.modalErrorTitle, 'Falha ao carregar dados. Estado será reiniciado.'); state.settings.agreedToTerms = false; } };
        const generateId = () => `chat_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;

        // showModal mantido igual
        const showModal = (titleKey, bodyContent, footerButtons = [], modalId = 'generic-modal') => {
             const modal = document.getElementById(modalId); if (!modal) return;
             const modalTitle = modal.querySelector('.modal-title');
             const modalBody = modal.querySelector('.modal-body');
             const modalFooter = modal.querySelector('.modal-footer');
             const defaultCloseButton = modal.querySelector('.modal-footer [data-modal-close]');

             if (modalTitle) modalTitle.textContent = t[titleKey] || titleKey;
             if (modalBody) modalBody.innerHTML = bodyContent;

             if (modalFooter) {
                 modalFooter.querySelectorAll('.modal-button:not([data-modal-close])').forEach(btn => btn.remove());
                 footerButtons.forEach(btnConfig => {
                     const button = document.createElement('button');
                     button.textContent = t[btnConfig.text] || btnConfig.text;
                     button.classList.add('modal-button');
                     if (btnConfig.class) button.classList.add(...btnConfig.class.split(' '));
                     button.onclick = (event) => { event.stopPropagation(); if (btnConfig.onClick) btnConfig.onClick(); };
                     if (defaultCloseButton && modalFooter.contains(defaultCloseButton)) { modalFooter.insertBefore(button, defaultCloseButton); } else { modalFooter.appendChild(button); }
                 });
                 if (defaultCloseButton) {
                     const hasCustomButtons = footerButtons.length > 0;
                     const isSpecialModal = modalId === 'settings-modal' || modalId === 'policy-modal';
                     defaultCloseButton.style.display = (!hasCustomButtons || isSpecialModal) ? 'inline-flex' : 'none';
                     defaultCloseButton.textContent = t.modalClose || 'Fechar';
                 }
             }
             modal.classList.add('visible');
        };
        const closeModal = (modalId) => { const modal = document.getElementById(modalId); if (modal) modal.classList.remove('visible'); };
        const getGreetingKey = () => { const h = new Date().getHours(); return h < 12 ? 'greetingMorning' : h < 18 ? 'greetingAfternoon' : 'greetingEvening'; };
        const getRandomSuggestions = (count = 4) => { const allSuggestions = ['Me explique computação quântica em termos simples.', 'Qual a receita de bolo de chocolate?', 'Escreva um poema sobre a chuva.', 'Quais as últimas notícias sobre IA?', 'Dê ideias para umas férias em família.', 'Como funciona o armazenamento local do navegador?', 'Crie uma história curta de ficção científica.', 'Liste os prós e contras de trabalhar remotamente.', 'Sugira 3 filmes de ficção científica lançados nos últimos 5 anos.', 'Quais são os benefícios da meditação?', 'Como posso melhorar minha concentração ao estudar?', 'Resuma o conceito de "machine learning".']; return allSuggestions.sort(() => 0.5 - Math.random()).slice(0, count); };

        // applyTheme e applyAccentColor mantidos iguais
        const applyTheme = (theme) => {
            document.body.dataset.theme = theme;
            themeToggleBtn.textContent = theme === 'dark' ? t.settingsThemeToggleDark : t.settingsThemeToggleLight;
            state.settings.theme = theme;
            document.documentElement.style.colorScheme = theme;
            const root = document.documentElement;
            root.style.setProperty('--bg-color-rgb', theme === 'dark' ? '0, 0, 0' : '255, 255, 255');
        };
        const applyAccentColor = (color) => {
            document.documentElement.style.setProperty('--accent-color', color);
            const hex = color.replace('#', ''); const r = parseInt(hex.substring(0, 2), 16); const g = parseInt(hex.substring(2, 4), 16); const b = parseInt(hex.substring(4, 6), 16);
            const lum = (0.299 * r + 0.587 * g + 0.114 * b) / 255; const txtColor = lum > 0.5 ? '#000000' : '#ffffff';
            document.documentElement.style.setProperty('--accent-text-color', txtColor);
            state.settings.accentColor = color;
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.color === color));
        };

        // checkDailyLimit, incrementMessageCount, updateMessageLimitDisplay mantidos iguais
         const checkDailyLimit = (showAlert = true) => {
             const today = new Date().toDateString();
             if (state.settings.lastMessageDate !== today) {
                 state.settings.dailyMessageCount = 0; state.settings.lastMessageDate = today; saveState(); updateMessageLimitDisplay();
             }
             const remaining = MAX_DAILY_MESSAGES - state.settings.dailyMessageCount;
             if (remaining <= 0) { if (showAlert) showModal('modalLimitTitle', t.modalLimitBody.replace('{limit}', MAX_DAILY_MESSAGES)); return false; }
             if (remaining <= 3 && remaining > 0 && showAlert) { showModal('modalLimitWarningTitle', t.modalLimitWarningBody.replace('{remaining}', remaining)); }
             return true;
         };
         const incrementMessageCount = () => {
             const today = new Date().toDateString();
             if (state.settings.lastMessageDate !== today) { state.settings.dailyMessageCount = 1; state.settings.lastMessageDate = today; } else { state.settings.dailyMessageCount++; }
             saveState(); updateMessageLimitDisplay();
         };
         const updateMessageLimitDisplay = () => {
             const today = new Date().toDateString(); if (state.settings.lastMessageDate !== today) { state.settings.dailyMessageCount = 0; }
             const remaining = Math.max(0, MAX_DAILY_MESSAGES - state.settings.dailyMessageCount);
             if (messageLimitDisplay) { messageLimitDisplay.textContent = t.messageLimitStatus.replace('{remaining}', remaining).replace('{total}', MAX_DAILY_MESSAGES); }
         };

        // --- Funções de Renderização (simplificadas) --- //
        const renderChatList = () => {
            chatList.innerHTML = '';
            const sortedIds = Object.keys(state.chats).sort((a, b) => state.chats[b].createdAt - state.chats[a].createdAt);
            if (sortedIds.length === 0 && !state.currentChatId) { return; }
            sortedIds.forEach(chatId => {
                const chat = state.chats[chatId]; const li = document.createElement('li'); li.classList.add('chat-list-item'); li.dataset.chatId = chatId; if (chatId === state.currentChatId) li.classList.add('active');
                const nameSpan = document.createElement('span'); nameSpan.textContent = chat.name; nameSpan.style.overflow = 'hidden'; nameSpan.style.textOverflow = 'ellipsis'; nameSpan.style.whiteSpace = 'nowrap'; nameSpan.style.flexGrow = '1'; nameSpan.style.marginRight = '50px';
                const actionsDiv = document.createElement('div'); actionsDiv.classList.add('chat-item-actions');
                const renameBtn = document.createElement('button'); renameBtn.textContent = '✏️'; renameBtn.ariaLabel = t.chatItemRename;
                renameBtn.addEventListener('click', (e) => { e.stopPropagation(); renameChat(chatId); });
                const deleteBtn = document.createElement('button'); deleteBtn.textContent = '🗑️'; deleteBtn.ariaLabel = t.chatItemDelete;
                deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteChat(chatId); });
                actionsDiv.appendChild(renameBtn); actionsDiv.appendChild(deleteBtn); li.appendChild(nameSpan); li.appendChild(actionsDiv);
                li.addEventListener('click', () => { selectChat(chatId); }); chatList.appendChild(li);
            });
        };
        const renderMessages = (chatId) => {
            messageList.innerHTML = ''; const chat = state.chats[chatId];
            if (!chat || chat.messages.length === 0) { emptyChatState.style.display = 'flex'; messageList.style.display = 'none'; greeting.textContent = t[getGreetingKey()]; renderPromptSuggestions(); }
            else { emptyChatState.style.display = 'none'; messageList.style.display = 'flex'; chat.messages.forEach(msg => appendMessage(msg)); scrollToBottom(); }
            chatHeader.textContent = chat ? chat.name : t.chatHeaderDefault; updateInputButtonsState();
        };
        // appendMessage simplificada, remove lógica de imagem
        const appendMessage = (message) => {
             const { role, content } = message; // imageBase64 removido
             const messageElement = document.createElement('div'); messageElement.classList.add('message', role);
             const contentElement = document.createElement('div'); contentElement.classList.add('message-content');
             // Bloco if para imageBase64 removido
             if (content) { const textElement = document.createElement('div'); textElement.innerHTML = renderMarkdown(content); contentElement.appendChild(textElement); }
             const actionsElement = document.createElement('div'); actionsElement.classList.add('message-actions');
             const copyBtn = document.createElement('button'); copyBtn.textContent = '📋'; copyBtn.ariaLabel = t.messageCopy; copyBtn.onclick = () => copyToClipboard(content || ''); actionsElement.appendChild(copyBtn);
             if (role === 'ai' && state.chats[state.currentChatId]?.messages.length > 1) { const regenBtn = document.createElement('button'); regenBtn.textContent = '🔄'; regenBtn.ariaLabel = t.messageRegenerate; regenBtn.onclick = () => regenerateLastAiResponse(); actionsElement.appendChild(regenBtn); }
             messageElement.appendChild(contentElement); messageElement.appendChild(actionsElement); messageList.appendChild(messageElement);
             if (messageList.children.length > 0) { emptyChatState.style.display = 'none'; messageList.style.display = 'flex'; }
             scrollToBottom();
        };
        // renderMarkdown mantido igual
        const renderMarkdown = (text) => {
             if (!text) return '';
             const escapeHtml = (unsafe) => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
             let html = text; const codeBlocks = [];
             html = html.replace(/``````/gs, (match, lang, code) => { const index = codeBlocks.length; const escapedCode = escapeHtml(code.trim()); codeBlocks.push(`<pre><code class="language-${lang || ''}">${escapedCode}</code></pre>`); return `%%%CODEBLOCK${index}%%%`; });
             html = escapeHtml(html);
             html = html.replace(/^---\s*$/gm, '<hr>').replace(/^\*\*\*\s*$/gm, '<hr>').replace(/^___\s*$/gm, '<hr>');
             html = html.replace(/^###### (.*$)/gm, '<h6>$1</h6>').replace(/^##### (.*$)/gm, '<h5>$1</h5>').replace(/^#### (.*$)/gm, '<h4>$1</h4>').replace(/^### (.*$)/gm, '<h3>$1</h3>').replace(/^## (.*$)/gm, '<h2>$1</h2>').replace(/^# (.*$)/gm, '<h1>$1</h1>');
             html = html.replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>'); html = html.replace(/<\/blockquote>\n?<blockquote>/g, '\n');
             html = html.replace(/^\s*([-*+])\s+(.*$)/gm, (m, _, item) => `<li>${item}</li>`); html = html.replace(/(?:^<li>.*<\/li>\s*)+/gm, match => `<ul>\n${match.trim()}\n</ul>\n`);
             html = html.replace(/^\s*(\d+)\.\s+(.*$)/gm, (m, num, item) => `<li value="${num}">${item}</li>`); html = html.replace(/(?:^<li value="\d+">.*<\/li>\s*)+/gm, match => `<ol>\n${match.trim()}\n</ol>\n`);
             html = html.replace(/<\/ul>\s*<ul>/g, '</ul><ul>'); html = html.replace(/<\/ol>\s*<ol>/g, '</ol><ol>');
             html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
             html = html.replace(/\*\*([^\s*].*?[^\s*])\*\*/g, '<strong>$1</strong>').replace(/__([^\s_].*?[^\s_])__/g, '<strong>$1</strong>');
             html = html.replace(/(?<!\*)\*([^\s*].*?[^\s*])\*(?!\*)/g, '<em>$1</em>').replace(/(?<!_)_([^\s_].*?[^\s_])_(?!_)/g, '<em>$1</em>');
             html = html.replace(/`([^`]+)`/g, (m, code) => `<code>${escapeHtml(code)}</code>`);
             html = html.split(/\n{2,}/).map(p => { const trimmed = p.trim(); if (!trimmed) return ''; if (/^\s*<(pre|ul|ol|li|blockquote|h[1-6]|hr|p|div)|%%%CODEBLOCK/.test(trimmed)) { if (!/^\s*<(pre)|%%%CODEBLOCK/.test(trimmed)) { return trimmed.replace(/\n(?!<(ul|ol|li|blockquote|pre|p|h[1-6]|hr|div))/g, '<br>'); } return trimmed; } return `<p>${trimmed.replace(/\n/g, '<br>')}</p>`; }).join('\n');
             html = html.replace(/%%%CODEBLOCK(\d+)%%%/g, (match, index) => codeBlocks[parseInt(index)]);
             html = html.replace(/<br>\s*(<(ul|ol|li|blockquote|pre|p|h[1-6]|hr|div))/gi, '$1'); html = html.replace(/(<\/(ul|ol|blockquote|pre|p|h[1-6]|hr|div)>)\s*<br>/gi, '$1'); html = html.replace(/<li>\s*<br>/gi, '<li>').replace(/<br>\s*<\/li>/gi, '</li>');
             return html.trim();
        };
        // renderPromptSuggestions mantido igual
        const renderPromptSuggestions = () => {
             promptSuggestions.innerHTML = ''; const suggestions = getRandomSuggestions(4);
             suggestions.forEach(s => { const btn = document.createElement('button'); btn.textContent = s; btn.onclick = () => { messageInput.value = s; handleSendMessage(); }; promptSuggestions.appendChild(btn); });
        };
        // updateInputButtonsState simplificada
        const updateInputButtonsState = () => {
             const hasText = messageInput.value.trim() !== '';
             // Lógica de attachBtn e webSearchBtn removida
             messageInput.disabled = state.isAiResponding;
             messageInput.placeholder = state.isAiResponding ? t.inputPlaceholderWaiting : t.inputPlaceholder;
             sendBtn.disabled = state.isAiResponding || !hasText; // Só depende de ter texto agora
        };
        // scrollToBottom e adjustTextareaHeight mantidos iguais
        const scrollToBottom = () => { messageListWrapper.scrollTop = messageListWrapper.scrollHeight; };
        const adjustTextareaHeight = () => { messageInput.style.height = 'auto'; const minH = 40; const scrollH = messageInput.scrollHeight; messageInput.style.height = `${Math.max(minH, scrollH)}px`; };
        // showFullscreenImage e hideFullscreenImage mantidos, mas não serão chamados
        const showFullscreenImage = (src) => { fullscreenImage.src = src; fullscreenImageOverlay.classList.add('visible'); };
        const hideFullscreenImage = () => { fullscreenImageOverlay.classList.remove('visible'); fullscreenImage.src = '#'; };


        // --- Funções de Lógica do Chat (simplificadas) --- //
        // createNewChat e selectChat simplificadas
        const createNewChat = (save = true) => {
             const newChatId = generateId(); const existingChats = Object.keys(state.chats).length; const newChatName = `${t.chatHeaderDefault} ${existingChats + 1}`;
             state.chats[newChatId] = { id: newChatId, name: newChatName, messages: [], createdAt: Date.now() }; state.currentChatId = newChatId;
             // webSearchActive e removeAttachment removidos
             renderChatList(); renderMessages(newChatId); if (save) { saveState(); }
             messageInput.value = ''; adjustTextareaHeight(); updateInputButtonsState(); messageInput.focus();
        };
        const selectChat = (chatId) => {
             if (chatId === state.currentChatId || !state.chats[chatId]) return;
             state.currentChatId = chatId;
             // webSearchActive e removeAttachment removidos
             renderChatList(); renderMessages(chatId);
             messageInput.value = ''; adjustTextareaHeight(); updateInputButtonsState(); messageInput.focus();
        };
        // renameChat e deleteChat mantidos iguais
        const renameChat = (chatId) => { /* ... (código mantido) ... */ };
        const deleteChat = (chatId) => { /* ... (código mantido) ... */ };

        // handleSendMessage simplificada
        const handleSendMessage = async () => {
             const messageText = messageInput.value.trim();
             // imageToSend removido
             if (!messageText || state.isAiResponding || !checkDailyLimit()) return; // Condição simplificada
             if (!state.currentChatId || !state.chats[state.currentChatId]) { createNewChat(true); }
             const currentChat = state.chats[state.currentChatId];
             const userMessageObj = { role: 'user', content: messageText }; // imageBase64 removido
             appendMessage(userMessageObj); currentChat.messages.push(userMessageObj);
             messageInput.value = ''; adjustTextareaHeight();
             // removeAttachment removido
             state.isAiResponding = true; loadingOverlay.classList.add('visible'); updateInputButtonsState(); scrollToBottom();
             // Mapeamento de apiMessages simplificado (só texto)
             const apiMessages = currentChat.messages.map(msg => {
                 if (msg.role === 'user') { return { role: 'user', content: msg.content }; }
                 return { role: 'assistant', content: msg.content };
             }).filter(msg => msg && msg.content); // Filtra mensagens vazias que poderiam ocorrer

             incrementMessageCount(); currentRequestController = new AbortController();
             try {
                 // Chamada a callApi sem o argumento webSearch
                 const aiResponseContent = await callApi(apiMessages, currentRequestController.signal);
                 const aiMessage = { role: 'ai', content: aiResponseContent }; currentChat.messages.push(aiMessage); appendMessage(aiMessage);
             } catch (error) {
                 console.error("Erro na chamada da API:", error);
                 let errorMessageContent = error.name === 'AbortError' ? t.generationStopped : t.modalApiError.replace('{error}', error.message);
                 const errorMessageObj = { role: 'ai', content: errorMessageContent }; currentChat.messages.push(errorMessageObj); appendMessage(errorMessageObj);
             } finally { state.isAiResponding = false; loadingOverlay.classList.remove('visible'); updateInputButtonsState(); saveState(); scrollToBottom(); messageInput.focus(); currentRequestController = null; }
        };
        // regenerateLastAiResponse simplificada
        const regenerateLastAiResponse = async () => {
             if (state.isAiResponding) return; const currentChat = state.chats[state.currentChatId]; if (!currentChat || currentChat.messages.length < 1) return;
             let lastAiIndex = -1; for (let i = currentChat.messages.length - 1; i >= 0; i--) { if (currentChat.messages[i].role === 'ai') { lastAiIndex = i; break; } }
             if (lastAiIndex === -1 || lastAiIndex !== currentChat.messages.length - 1 || !checkDailyLimit()) return;
             const originalAiMessage = currentChat.messages.pop();
             const msgElements = messageList.querySelectorAll('.message'); if (msgElements.length > 0) { msgElements[msgElements.length - 1].remove(); } else { console.warn("Desincronização UI/Estado ao tentar regenerar."); renderMessages(state.currentChatId); return; }
             // Mapeamento de apiMessages simplificado (só texto)
             const apiMessages = currentChat.messages.map(msg => {
                if (msg.role === 'user') { return { role: 'user', content: msg.content }; }
                return { role: 'assistant', content: msg.content };
            }).filter(msg => msg && msg.content);

             state.isAiResponding = true; loadingOverlay.classList.add('visible'); updateInputButtonsState(); scrollToBottom(); incrementMessageCount(); currentRequestController = new AbortController();
             try {
                // Chamada a callApi sem o argumento webSearch
                 const aiResponseContent = await callApi(apiMessages, currentRequestController.signal);
                 const newAiMessage = { role: 'ai', content: aiResponseContent }; currentChat.messages.push(newAiMessage); appendMessage(newAiMessage);
             } catch (error) {
                 console.error("Erro ao regenerar:", error);
                 let errorMessageContent = error.name === 'AbortError' ? t.generationStopped : t.modalApiRegenError.replace('{error}', error.message);
                 if (error.name !== 'AbortError') { currentChat.messages.push(originalAiMessage); appendMessage(originalAiMessage); console.error("Regeneração falhou, resposta original restaurada."); }
                 else { const errorMessageObj = { role: 'ai', content: errorMessageContent }; currentChat.messages.push(errorMessageObj); appendMessage(errorMessageObj); }
             } finally { state.isAiResponding = false; loadingOverlay.classList.remove('visible'); updateInputButtonsState(); saveState(); scrollToBottom(); messageInput.focus(); currentRequestController = null; }
        };
        // copyToClipboard mantido igual
        const copyToClipboard = (text) => { /* ... (código mantido) ... */ };
        // handleFileUpload e removeAttachment removidos

        // --- Funções de Chamada de API (simplificada) --- //
        // callApi simplificada, remove lógica de web search e imagens
        const callApi = async (formattedMessages, signal) => {
             // modelConfig não é mais usado aqui, modelId direto
             const modelId = MODEL_ID;

             let endpoint = '/.netlify/functions/openrouter-proxy';
             let headers = { 'Content-Type': 'application/json' };
             let body = {};

             // Lógica de prompt de sistema mantida
             let systemContent = state.settings.customInstructions || '';
             if (state.settings.userName) systemContent += (systemContent ? '\n' : '') + `O nome do usuário é ${state.settings.userName}.`;
             if (state.settings.aiLang !== 'auto') systemContent += (systemContent ? '\n' : '') + `Responda no idioma: ${state.settings.aiLang}.`;

             const finalApiMessages = [];
             if (systemContent.trim()) { finalApiMessages.push({ role: 'system', content: systemContent.trim() }); }
             // Usa formattedMessages diretamente (já simplificado na chamada)
             finalApiMessages.push(...formattedMessages);

             // Lógica de effectiveModelId removida (não há mais web search)
             const effectiveModelId = modelId;

             body = {
                 model: effectiveModelId,
                 messages: finalApiMessages
             };

             console.log("Proxy Frontend: Enviando para função Netlify:", JSON.stringify(body, null, 2));

             try {
                 const response = await fetch(endpoint, {
                     method: 'POST',
                     headers: headers,
                     body: JSON.stringify(body),
                     signal
                 });

                 if (!response.ok) {
                     const errorData = await response.json().catch(() => ({ message: `Erro ${response.status} ao chamar o proxy Netlify.` }));
                     console.error("Proxy Frontend: Erro retornado pelo Proxy Netlify:", errorData);
                     const errorMessage = errorData?.error?.message || errorData?.details || errorData?.message || `Erro ${response.status}`;
                     throw new Error(`Erro Proxy/API: ${errorMessage}`);
                 }

                 const data = await response.json();
                 console.log("Proxy Frontend: Resposta recebida (via Proxy Netlify):", data);

                 if (data.choices && data.choices[0] && data.choices[0].message) {
                     return data.choices[0].message.content || '';
                 } else if (data.error) {
                      console.error("Proxy Frontend: Erro da API OpenRouter (via proxy):", data.error);
                      throw new Error(`Erro API (via Proxy): ${data.error.message || 'Erro desconhecido'}`);
                 } else {
                     console.warn("Proxy Frontend: Formato de resposta inesperado da API (via proxy):", data);
                     throw new Error('Resposta da API (via Proxy) em formato inválido.');
                 }
             } catch (error) {
                  console.error("Proxy Frontend: Erro ao chamar a função proxy ou processar resposta:", error);
                  if (error.name === 'AbortError') { throw error; }
                  const finalErrorMessage = error.message.startsWith('Erro Proxy/API:') || error.message.startsWith('Erro API (via Proxy):') ? error.message : `Erro na comunicação: ${error.message}`;
                  throw new Error(finalErrorMessage);
             }
        };


        // --- Funções de Conteúdo Estático (Mantidas iguais) --- //
        const formatPolicyText = (text) => text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        const getTermsOfUseContent = () => { /* ... (conteúdo dos termos mantido, talvez atualizar para remover menção a features removidas) ... */ return formatPolicyText("..."); };
        const getPrivacyPolicyContent = () => { /* ... (conteúdo da política mantido, talvez atualizar para remover menção a features removidas) ... */ return formatPolicyText("..."); };
        const showPolicyModal = (type) => { const titleKey = type === 'terms' ? 'termsLink' : 'privacyLink'; const content = type === 'terms' ? getTermsOfUseContent() : getPrivacyPolicyContent(); const policyModalTitle = document.getElementById('policy-modal-title'); const policyModalBody = document.getElementById('policy-modal-body'); if (policyModalTitle) policyModalTitle.textContent = t[titleKey] || titleKey; if (policyModalBody) policyModalBody.innerHTML = content; policyModal.classList.add('visible'); };

        // --- Inicialização e Listeners (simplificados) --- //
        const initializeSettings = () => {
             applyTheme(state.settings.theme); applyAccentColor(state.settings.accentColor); aiLangSelect.value = state.settings.aiLang; userNameInput.value = state.settings.userName; customInstructionsTextarea.value = state.settings.customInstructions;
             aiLangSelect.addEventListener("change", (e) => { state.settings.aiLang = e.target.value; saveState(); }); userNameInput.addEventListener("input", (e) => { state.settings.userName = e.target.value; saveState(); }); customInstructionsTextarea.addEventListener("input", (e) => { state.settings.customInstructions = e.target.value; saveState(); });
             suggestionBtns.forEach(btn => { btn.addEventListener('click', () => { customInstructionsTextarea.value += (customInstructionsTextarea.value ? '\n' : '') + btn.dataset.suggestion; state.settings.customInstructions = customInstructionsTextarea.value; saveState(); }); });
             colorOptionsContainer.querySelectorAll('.color-option').forEach(option => { option.addEventListener('click', () => { applyAccentColor(option.dataset.color); saveState(); }); });
             themeToggleBtn.addEventListener('click', () => { const newTheme = state.settings.theme === 'light' ? 'dark' : 'light'; applyTheme(newTheme); saveState(); });
             clearDataBtn.addEventListener('click', () => {
                 showModal('modalConfirmClearDataTitle', t.modalConfirmClearDataBody, [{ text: 'modalCancel', class: '', onClick: () => closeModal('generic-modal') }, { text: 'modalConfirmClearDataButton', class: 'danger', onClick: () => { localStorage.removeItem('auriState'); const agreed = state.settings.agreedToTerms; state = { chats: {}, currentChatId: null, settings: { theme: 'dark', accentColor: '#3b82f6', aiLang: 'auto', userName: '', customInstructions: '', agreedToTerms: agreed, dailyMessageCount: 0, lastMessageDate: null }, isAiResponding: false }; /* Removido webSearchActive, attachedImage */ initializeAppUI(); closeModal('generic-modal'); closeModal('settings-modal'); showModal('modalSuccessTitle', 'Todos os dados locais foram limpos com sucesso.'); } }], 'generic-modal');
             });
             settingsTermsLink.addEventListener('click', (e) => { e.preventDefault(); showPolicyModal('terms'); }); settingsPrivacyLink.addEventListener('click', (e) => { e.preventDefault(); showPolicyModal('privacy'); });
             updateMessageLimitDisplay();
        };
        const initializeAppUI = () => {
             initializeSettings(); applyTranslations(); renderChatList();
             if (state.currentChatId && state.chats[state.currentChatId]) { renderMessages(state.currentChatId); }
             else { const sortedIds = Object.keys(state.chats).sort((a, b) => state.chats[b].createdAt - state.chats[a].createdAt); if (sortedIds.length > 0) { selectChat(sortedIds[0]); } else if (state.settings.agreedToTerms) { createNewChat(false); } }
             updateInputButtonsState(); adjustTextareaHeight(); sidebarToggleBtn.classList.toggle('outside', sidebar.classList.contains('collapsed')); sidebarToggleBtn.textContent = sidebar.classList.contains('collapsed') ? '☰' : '✕';
        };
        const initializeApp = () => {
             loadState();
             if (!state.settings.agreedToTerms) { agreementModal.classList.add('visible'); } else { initializeAppUI(); }
             sidebarToggleBtn.addEventListener('click', () => { const isCollapsed = sidebar.classList.toggle('collapsed'); sidebarToggleBtn.classList.toggle('outside', isCollapsed); sidebarToggleBtn.textContent = isCollapsed ? '☰' : '✕'; });
             newChatBtn.addEventListener('click', createNewChat); settingsBtn.addEventListener('click', () => { updateMessageLimitDisplay(); settingsModal.classList.add('visible'); });
             document.querySelectorAll('[data-modal-close]').forEach(btn => { btn.addEventListener('click', () => closeModal(btn.dataset.modalClose)); });
             document.querySelectorAll('.modal-overlay').forEach(ov => { ov.addEventListener('click', (e) => { if (e.target === ov && ov.id !== 'agreement-modal' && ov.id !== 'loading-overlay' && ov.id !== 'fullscreen-image-overlay') { closeModal(ov.id); } }); });
             messageInput.addEventListener('input', () => { adjustTextareaHeight(); updateInputButtonsState(); }); messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } if (emptyChatState.style.display !== 'none') { emptyChatState.style.display = 'none'; messageList.style.display = 'flex'; } });
             sendBtn.addEventListener('click', handleSendMessage);
             // Listeners para attachBtn, fileInput, removeAttachmentBtn, webSearchBtn removidos
             agreeBtn.addEventListener('click', () => { state.settings.agreedToTerms = true; closeModal('agreement-modal'); initializeAppUI(); saveState(); });
             agreementTermsLink.addEventListener('click', (e) => { e.preventDefault(); showPolicyModal('terms'); }); agreementPrivacyLink.addEventListener('click', (e) => { e.preventDefault(); showPolicyModal('privacy'); });
             stopGenerationBtn.addEventListener('click', () => { if (currentRequestController) { currentRequestController.abort(); console.log("Tentando interromper a geração..."); } });
             fullscreenImageOverlay.addEventListener('click', hideFullscreenImage);
             document.addEventListener('click', (e) => { if (window.innerWidth <= 768 && !sidebar.classList.contains('collapsed')) { if (!sidebar.contains(e.target) && !sidebarToggleBtn.contains(e.target)) { sidebar.classList.add('collapsed'); sidebarToggleBtn.classList.add('outside'); sidebarToggleBtn.textContent = '☰'; } } });
        };

        // Inicia a aplicação
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

</body>
</html>
